import { NextResponse } from 'next/server';
import { GoogleGenerativeAI, HarmCategory, HarmBlockThreshold, SchemaType, GenerationConfig } from "@google/generative-ai";
// Removed duplicate import line below
import type { LlmContext } from '@/types';
import { SYSTEM_PROMPT_TEXT } from '@/lib/prompts/system-prompt'; // Import the prompt
import { logger } from '@/lib/logger'; // Import the new logger
// --- System Prompt ---
// Use the imported prompt constant
const systemPromptText = SYSTEM_PROMPT_TEXT;

// --- Gemini Configuration ---
const apiKey = process.env.GEMINI_API_KEY;
const genAI = apiKey ? new GoogleGenerativeAI(apiKey) : null;

const model = genAI?.getGenerativeModel({
  // Use a model supporting JSON mode
  // model: "gemini-2.0-flash", 
   model: "gemini-2.5-pro-exp-03-25",
});

const generationConfig: GenerationConfig = { // Explicitly type the config
  temperature: 0.1, // Adjust for creativity vs consistency
  topP: 0.95,
  topK: 40,
  maxOutputTokens: 1000, // Reduced token limit as requested
  responseMimeType: "application/json",
  responseSchema: { // Use SchemaType enum values
    type: SchemaType.OBJECT, // Corrected: Use enum for top-level type
    properties: {
      responseText: { type: SchemaType.STRING, nullable: true }, // Allow null
      action: {
        type: SchemaType.OBJECT,
        properties: {
          type: { type: SchemaType.STRING },
          payload: { // Define expected optional payload properties
            type: SchemaType.OBJECT,
            properties: {
              lessonId: { type: SchemaType.STRING, nullable: true },
              quizId: { type: SchemaType.STRING, nullable: true }
            },
            // Note: 'required' field is omitted here, making properties optional by default
          }
        },
        nullable: true // Allow action to be null
      },
      reasoning: { type: SchemaType.STRING, nullable: true },
      contextUpdates: {
        type: SchemaType.OBJECT,
        nullable: true,
        properties: { // Define expected optional context update properties
            conceptsMastered: { type: SchemaType.ARRAY, items: { type: SchemaType.STRING }, nullable: true },
            conceptsStruggling: { type: SchemaType.ARRAY, items: { type: SchemaType.STRING }, nullable: true },
            conceptsIntroduced: { type: SchemaType.ARRAY, items: { type: SchemaType.STRING }, nullable: true },
            // Add other potential context fields here if needed
        }
      },
      flagsPreviousMessageAsInappropriate: { type: SchemaType.BOOLEAN, nullable: true }
    },
    required: ["responseText", "action", "reasoning", "contextUpdates", "flagsPreviousMessageAsInappropriate"] // All fields required
  },
};

// Safety settings (adjust as needed)
const safetySettings = [
  { category: HarmCategory.HARM_CATEGORY_HARASSMENT, threshold: HarmBlockThreshold.BLOCK_MEDIUM_AND_ABOVE },
  { category: HarmCategory.HARM_CATEGORY_HATE_SPEECH, threshold: HarmBlockThreshold.BLOCK_MEDIUM_AND_ABOVE },
  { category: HarmCategory.HARM_CATEGORY_SEXUALLY_EXPLICIT, threshold: HarmBlockThreshold.BLOCK_MEDIUM_AND_ABOVE },
  { category: HarmCategory.HARM_CATEGORY_DANGEROUS_CONTENT, threshold: HarmBlockThreshold.BLOCK_MEDIUM_AND_ABOVE },
];

// --- API Route Handler ---
export async function POST(request: Request) {
  // Use general logger here as reqLogger is not yet initialized
  if (!apiKey || !genAI || !model) {
    logger.error("Gemini API key or client not initialized. Cannot process request.");
    return NextResponse.json({ error: "API not configured correctly." }, { status: 500 });
  }

  // Start request logging
  const reqLogger = logger.startRequest({ path: request.url, method: request.method });

  let requestBody: any; // Keep 'any' for flexibility or define a strict input type
  try {
    // Clone the request to read the body safely
    const rawBody = await request.text(); // Read as text first for logging
    reqLogger.logPayload('request', rawBody); // Log raw body (or size in prod)
    try {
        requestBody = JSON.parse(rawBody); // Now parse
    } catch (parseError) {
        reqLogger.error("Error parsing request body JSON", parseError instanceof Error ? parseError : { error: parseError });
        reqLogger.endRequest(400, { error: "Invalid JSON format" });
        return NextResponse.json({ error: "Invalid request body: Malformed JSON." }, { status: 400 });
    }
  } catch (error) {
    reqLogger.error("Error reading request body", error instanceof Error ? error : { error: error });
    reqLogger.endRequest(500, { error: "Failed to read request body" });
    return NextResponse.json({ error: "Failed to read request body." }, { status: 500 });
  }

  const { currentUserMessage, currentLlmContext, availableLessons, currentLessonData } = requestBody;

  if (!currentUserMessage || !currentLlmContext || !availableLessons) {
    reqLogger.warn("Missing required fields in request body.", {
        hasCurrentUserMessage: !!currentUserMessage,
        hasCurrentLlmContext: !!currentLlmContext,
        hasAvailableLessons: !!availableLessons,
    });
    reqLogger.endRequest(400, { error: "Missing required fields" });
    return NextResponse.json({ error: "Missing required fields in request body." }, { status: 400 });
  }

  // Construct the input for the model
  const parts = [
    { text: systemPromptText }, // Use the constant here      
    {text: "input: {\n\"currentUserMessage\": \"Let's begin\",\n\"currentLlmContext\": {\n\"studentProfile\": {\n\"name\": \"Alex\",\n\"grade\": 5,\n\"age\": 10,\n\"learningStyle\": \"Visual\",\n\"challenges\": []\n},\n\"currentLesson\": null,\n\"currentQuiz\": null,\n\"progressHistory\": [],\n\"recentInteractions\": [],\n\"conceptsIntroduced\": [],\n\"conceptsMastered\": [],\n\"conceptsStruggling\": []\n},\n\"availableLessons\": {\n\"lesson1\": \"Introduction to Numbers\",\n\"lesson2\": \"Basic Addition\",\n\"lesson3\": \"Counting Objects\"\n},\n\"currentLessonData\": null\n}"},
    {text: "output: {\n  \"responseText\": \"Great! Let's start with 'Introduction to Numbers'.\",\n  \"action\": {\n    \"type\": \"showLessonOverview\",\n    \"payload\": {\n      \"lessonId\": \"lesson1\"\n    }\n  },\n  \"reasoning\": \"User wants to start, no active lesson. Initiating first lesson overview.\",\n  \"contextUpdates\": null\n}"},
    {text: "input: {\"currentUserMessage\": \"Okay, show me the first activity\",  \"currentLlmContext\": {    \"studentProfile\": {      \"name\": \"Alex\",      \"grade\": 5,      \"age\": 10,      \"learningStyle\": \"Visual\",      \"challenges\": []    },    \"currentLesson\": {      \"id\": \"lesson1\",      \"data\": {        \"id\": \"lesson1\",        \"title\": \"Introduction to Numbers\",        \"description\": \"An introduction to basic numbers.\",        \"concepts\": [\"counting\", \"number_identity\"],        \"subject\": \"Math\",        \"progress\": \"in-progress\",        \"quizzes\": [          { \"id\": \"quizA\", \"title\": \"Number Recognition\", \"type\": \"multiple-choice\", \"concepts\": [\"number_identity\"], \"items\": [] }        ],        \"nextLesson\": \"lesson2\",        \"prevLesson\": null      },      \"startTime\": \"2025-03-31T08:05:00.000Z\",      \"progressPercentage\": 0    },    \"currentQuiz\": null,    \"progressHistory\": [],    \"recentInteractions\": [      { \"user\": \"Let's begin\" },      { \"ai_response\": { } }    ],    \"conceptsIntroduced\": [\"counting\", \"number_identity\"],    \"conceptsMastered\": [],    \"conceptsStruggling\": []  },  \"availableLessons\": {    \"lesson1\": \"Introduction to Numbers\",    \"lesson2\": \"Basic Addition\",    \"lesson3\": \"Counting Objects\"  },  \"currentLessonData\": {    \"id\": \"lesson1\",    \"title\": \"Introduction to Numbers\",    \"description\": \"An introduction to basic numbers.\",    \"concepts\": [\"counting\", \"number_identity\"],    \"subject\": \"Math\",    \"progress\": \"in-progress\",    \"quizzes\": [      { \"id\": \"quizA\", \"title\": \"Number Recognition\", \"type\": \"multiple-choice\", \"concepts\": [\"number_identity\"], \"items\": [] }    ],    \"nextLesson\": \"lesson2\",    \"prevLesson\": null  }}"},
    {text: "output: {\n  \"responseText\": \"Okay, here's the first activity for this lesson: 'Number Recognition'.\",\n  \"action\": {\n    \"type\": \"showQuiz\",\n    \"payload\": {\n      \"lessonId\": \"lesson1\",\n      \"quizId\": \"quizA\"\n    }\n  },\n  \"reasoning\": \"User requested the first quiz of the active lesson.\",\n  \"contextUpdates\": null\n}"},
    {text: "input: {  \"currentUserMessage\": \"I think it's 5\",  \"currentLlmContext\": {    \"studentProfile\": {      \"name\": \"Alex\",      \"grade\": 5,      \"age\": 10,      \"learningStyle\": \"Visual\",      \"challenges\": []    },    \"currentLesson\": {      \"id\": \"lesson1\",      \"data\": {        \"id\": \"lesson1\",        \"title\": \"Introduction to Numbers\",        \"description\": \"An introduction to basic numbers.\",        \"concepts\": [\"counting\", \"number_identity\"],        \"subject\": \"Math\",        \"progress\": \"in-progress\",        \"quizzes\": [          {            \"id\": \"quizA\",            \"title\": \"Number Recognition\",            \"type\": \"multiple-choice\",            \"concepts\": [\"number_identity\"],            \"items\": [              {                \"question\": \"What number comes after 4?\",                \"options\": [                  { \"text\": \"3\", \"correct\": false },                  { \"text\": \"5\", \"correct\": true },                  { \"text\": \"6\", \"correct\": false }                ]              }            ]          }        ],        \"nextLesson\": \"lesson2\",        \"prevLesson\": null      },      \"startTime\": \"2025-03-31T08:05:00.000Z\",      \"progressPercentage\": 0    },    \"currentQuiz\": {      \"id\": \"quizA\",      \"data\": {         \"id\": \"quizA\",         \"title\": \"Number Recognition\",         \"type\": \"multiple-choice\",         \"concepts\": [\"number_identity\"],         \"items\": [           {             \"question\": \"What number comes after 4?\",             \"options\": [               { \"text\": \"3\", \"correct\": false },               { \"text\": \"5\", \"correct\": true },               { \"text\": \"6\", \"correct\": false }             ]           }         ]      },      \"startTime\": \"2025-03-31T08:08:00.000Z\",      \"attempts\": 0,      \"answers\": {},      \"correctCount\": 0    },    \"progressHistory\": [],    \"recentInteractions\": [      { \"user\": \"Let's begin\" },      { \"ai_response\": { \"responseText\": \"Great! Let's begin...\", \"action\": { \"type\": \"showLessonOverview\", \"payload\": { \"lessonId\": \"lesson1\" } } } },      { \"user\": \"Okay, show me the first activity\" },      { \"ai_response\": { \"responseText\": \"Okay, here's the first activity...\", \"action\": { \"type\": \"showQuiz\", \"payload\": { \"lessonId\": \"lesson1\", \"quizId\": \"quizA\" } } } }    ],    \"conceptsIntroduced\": [\"counting\", \"number_identity\"],    \"conceptsMastered\": [],    \"conceptsStruggling\": []  },  \"availableLessons\": {    \"lesson1\": \"Introduction to Numbers\",    \"lesson2\": \"Basic Addition\",    \"lesson3\": \"Counting Objects\"  },  \"currentLessonData\": {    \"id\": \"lesson1\",    \"title\": \"Introduction to Numbers\",    \"description\": \"An introduction to basic numbers.\",    \"concepts\": [\"counting\", \"number_identity\"],    \"subject\": \"Math\",    \"progress\": \"in-progress\",    \"quizzes\": [      {        \"id\": \"quizA\",        \"title\": \"Number Recognition\",        \"type\": \"multiple-choice\",        \"concepts\": [\"number_identity\"],        \"items\": [          {            \"question\": \"What number comes after 4?\",            \"options\": [              { \"text\": \"3\", \"correct\": false },              { \"text\": \"5\", \"correct\": true },              { \"text\": \"6\", \"correct\": false }            ]          }        ]      }    ],    \"nextLesson\": \"lesson2\",    \"prevLesson\": null  }}"},
    {text: "output: {\n  \"responseText\": \"Yes, that's correct! 5 comes after 4. Great job!\",\n  \"action\": null,\n  \"reasoning\": \"The user answered the current quiz question correctly.\",\n  \"contextUpdates\": {\n    \"conceptsMastered\": [\n      \"number_identity\"\n    ]\n  }\n}"},
    {text: "input: {  \"currentUserMessage\": \"I'm done with this lesson\",  \"currentLlmContext\": {    \"studentProfile\": {      \"name\": \"Alex\",      \"grade\": 5,      \"age\": 10,      \"learningStyle\": \"Visual\",      \"challenges\": []    },    \"currentLesson\": {      \"id\": \"lesson1\",      \"data\": {        \"id\": \"lesson1\",        \"title\": \"Introduction to Numbers\",        \"description\": \"An introduction to basic numbers.\",        \"concepts\": [\"counting\", \"number_identity\"],        \"subject\": \"Math\",        \"progress\": \"in-progress\",        \"quizzes\": [          { \"id\": \"quizA\", \"title\": \"Number Recognition\", \"type\": \"multiple-choice\", \"concepts\": [\"number_identity\"], \"items\": [ { \"question\": \"What number comes after 4?\", \"options\": [ { \"text\": \"3\", \"correct\": false }, { \"text\": \"5\", \"correct\": true }, { \"text\": \"6\", \"correct\": false } ] } ] },          { \"id\": \"quizB\", \"title\": \"Counting Practice\", \"type\": \"list\", \"concepts\": [\"counting\"], \"items\": [] }        ],        \"nextLesson\": \"lesson2\",        \"prevLesson\": null      },      \"startTime\": \"2025-03-31T10:15:00.000Z\",      \"progressPercentage\": 95    },    \"currentQuiz\": null,    \"progressHistory\": [],    \"recentInteractions\": [      { \"user\": \"Let's begin\" },      { \"ai_response\": { \"action\": { \"type\": \"showLessonOverview\", \"payload\": { \"lessonId\": \"lesson1\" } } } },      { \"user\": \"Okay, show me the first activity\" },      { \"ai_response\": { \"action\": { \"type\": \"showQuiz\", \"payload\": { \"lessonId\": \"lesson1\", \"quizId\": \"quizA\" } } } },      { \"user\": \"I think it's 5\" },      { \"ai_response\": { \"responseText\": \"Yes, that's correct! 5 comes after 4. Great job!\", \"contextUpdates\": { \"conceptsMastered\": [\"number_identity\"] } } },      { \"user\": \"show quiz B\" },      { \"ai_response\": { \"action\": { \"type\": \"showQuiz\", \"payload\": { \"lessonId\": \"lesson1\", \"quizId\": \"quizB\" } } } }    ],    \"conceptsIntroduced\": [\"counting\", \"number_identity\"],    \"conceptsMastered\": [\"number_identity\", \"counting\"],    \"conceptsStruggling\": []  },  \"availableLessons\": {    \"lesson1\": \"Introduction to Numbers\",    \"lesson2\": \"Basic Addition\",    \"lesson3\": \"Counting Objects\"  },  \"currentLessonData\": {    \"id\": \"lesson1\",    \"title\": \"Introduction to Numbers\",    \"description\": \"An introduction to basic numbers.\",    \"concepts\": [\"counting\", \"number_identity\"],    \"subject\": \"Math\",    \"progress\": \"in-progress\",    \"quizzes\": [      { \"id\": \"quizA\", \"title\": \"Number Recognition\", \"type\": \"multiple-choice\", \"concepts\": [\"number_identity\"], \"items\": [ { \"question\": \"What number comes after 4?\", \"options\": [ { \"text\": \"3\", \"correct\": false }, { \"text\": \"5\", \"correct\": true }, { \"text\": \"6\", \"correct\": false } ] } ] },      { \"id\": \"quizB\", \"title\": \"Counting Practice\", \"type\": \"list\", \"concepts\": [\"counting\"], \"items\": [] }    ],    \"nextLesson\": \"lesson2\",    \"prevLesson\": null  }}"},
    {text: "output: {\n  \"responseText\": \"Okay! Let's mark 'Introduction to Numbers' as complete.\",\n  \"action\": {\n    \"type\": \"completeLesson\",\n    \"payload\": {\n      \"lessonId\": \"lesson1\"\n    }\n  },\n  \"reasoning\": \"The user indicated they are finished with the current lesson.\",\n  \"contextUpdates\": null\n}"},
    {text: "input: {  \"currentUserMessage\": \"What does number identity mean?\",  \"currentLlmContext\": {    \"studentProfile\": {      \"name\": \"Alex\",      \"grade\": 5,      \"age\": 10,      \"learningStyle\": \"Visual\",      \"challenges\": []    },    \"currentLesson\": {      \"id\": \"lesson1\",      \"data\": {        \"id\": \"lesson1\",        \"title\": \"Introduction to Numbers\",        \"description\": \"An introduction to basic numbers.\",        \"concepts\": [\"counting\", \"number_identity\"],        \"subject\": \"Math\",        \"progress\": \"in-progress\",        \"quizzes\": [          { \"id\": \"quizA\", \"title\": \"Number Recognition\", \"type\": \"multiple-choice\", \"concepts\": [\"number_identity\"], \"items\": [ { \"question\": \"What number comes after 4?\", \"options\": [ { \"text\": \"3\", \"correct\": false }, { \"text\": \"5\", \"correct\": true }, { \"text\": \"6\", \"correct\": false } ] } ] },          { \"id\": \"quizB\", \"title\": \"Counting Practice\", \"type\": \"list\", \"concepts\": [\"counting\"], \"items\": [] }        ],        \"nextLesson\": \"lesson2\",        \"prevLesson\": null      },      \"startTime\": \"2025-03-31T10:15:00.000Z\",      \"progressPercentage\": 15    },    \"currentQuiz\": {       \"id\": \"quizA\",       \"data\": { \"id\": \"quizA\", \"title\": \"Number Recognition\", \"type\": \"multiple-choice\", \"concepts\": [\"number_identity\"], \"items\": [ { \"question\": \"What number comes after 4?\", \"options\": [ { \"text\": \"3\", \"correct\": false }, { \"text\": \"5\", \"correct\": true }, { \"text\": \"6\", \"correct\": false } ] } ] },       \"startTime\": \"2025-03-31T10:18:00.000Z\",       \"attempts\": 0,       \"answers\": {},       \"correctCount\": 0    },    \"progressHistory\": [],    \"recentInteractions\": [      { \"user\": \"Let's begin\" },      { \"ai_response\": { \"action\": { \"type\": \"showLessonOverview\", \"payload\": { \"lessonId\": \"lesson1\" } } } },      { \"user\": \"Okay, show me the first activity\" },      { \"ai_response\": { \"action\": { \"type\": \"showQuiz\", \"payload\": { \"lessonId\": \"lesson1\", \"quizId\": \"quizA\" } } } }    ],    \"conceptsIntroduced\": [\"counting\", \"number_identity\"],    \"conceptsMastered\": [],    \"conceptsStruggling\": []  },  \"availableLessons\": {    \"lesson1\": \"Introduction to Numbers\",    \"lesson2\": \"Basic Addition\",    \"lesson3\": \"Counting Objects\"  },  \"currentLessonData\": {    \"id\": \"lesson1\",    \"title\": \"Introduction to Numbers\",    \"description\": \"An introduction to basic numbers.\",    \"concepts\": [\"counting\", \"number_identity\"],    \"subject\": \"Math\",    \"progress\": \"in-progress\",    \"quizzes\": [      { \"id\": \"quizA\", \"title\": \"Number Recognition\", \"type\": \"multiple-choice\", \"concepts\": [\"number_identity\"], \"items\": [ { \"question\": \"What number comes after 4?\", \"options\": [ { \"text\": \"3\", \"correct\": false }, { \"text\": \"5\", \"correct\": true }, { \"text\": \"6\", \"correct\": false } ] } ] },      { \"id\": \"quizB\", \"title\": \"Counting Practice\", \"type\": \"list\", \"concepts\": [\"counting\"], \"items\": [] }    ],    \"nextLesson\": \"lesson2\",    \"prevLesson\": null  }}"},
    {text: "output: {\n  \"responseText\": \"Number identity means that a number represents a specific quantity and maintains its value. For example, the number 5 always represents five items.\",\n  \"action\": null,\n  \"reasoning\": \"The user asked a question about a core concept in the current lesson.\",\n  \"contextUpdates\": null\n}"},
    {text: "input: {  \"currentUserMessage\": \"next lesson please\",  \"currentLlmContext\": {    \"studentProfile\": {      \"name\": \"Alex\",      \"grade\": 5,      \"age\": 10,      \"learningStyle\": \"Visual\",      \"challenges\": []    },    \"currentLesson\": {      \"id\": \"lesson1\",      \"data\": {        \"id\": \"lesson1\",        \"title\": \"Introduction to Numbers\",        \"description\": \"An introduction to basic numbers.\",        \"concepts\": [\"counting\", \"number_identity\"],        \"subject\": \"Math\",        \"progress\": \"in-progress\",        \"quizzes\": [          { \"id\": \"quizA\", \"title\": \"Number Recognition\", \"type\": \"multiple-choice\", \"concepts\": [\"number_identity\"], \"items\": [ { \"question\": \"What number comes after 4?\", \"options\": [ { \"text\": \"3\", \"correct\": false }, { \"text\": \"5\", \"correct\": true }, { \"text\": \"6\", \"correct\": false } ] } ] },          { \"id\": \"quizB\", \"title\": \"Counting Practice\", \"type\": \"list\", \"concepts\": [\"counting\"], \"items\": [] }        ],        \"nextLesson\": \"lesson2\",        \"prevLesson\": null      },      \"startTime\": \"2025-03-31T10:15:00.000Z\",      \"progressPercentage\": 50    },    \"currentQuiz\": null,    \"progressHistory\": [],    \"recentInteractions\": [      { \"user\": \"Let's begin\" },      { \"ai_response\": { \"action\": { \"type\": \"showLessonOverview\", \"payload\": { \"lessonId\": \"lesson1\" } } } },      { \"user\": \"Okay, show me the first activity\" },      { \"ai_response\": { \"action\": { \"type\": \"showQuiz\", \"payload\": { \"lessonId\": \"lesson1\", \"quizId\": \"quizA\" } } } },      { \"user\": \"I think it's 5\" },      { \"ai_response\": { \"responseText\": \"Yes, that's correct! 5 comes after 4. Great job!\", \"contextUpdates\": { \"conceptsMastered\": [\"number_identity\"] } } }    ],    \"conceptsIntroduced\": [\"counting\", \"number_identity\"],    \"conceptsMastered\": [\"number_identity\"],    \"conceptsStruggling\": []  },  \"availableLessons\": {    \"lesson1\": \"Introduction to Numbers\",    \"lesson2\": \"Basic Addition\",    \"lesson3\": \"Counting Objects\"  },  \"currentLessonData\": {    \"id\": \"lesson1\",    \"title\": \"Introduction to Numbers\",    \"description\": \"An introduction to basic numbers.\",    \"concepts\": [\"counting\", \"number_identity\"],    \"subject\": \"Math\",    \"progress\": \"in-progress\",    \"quizzes\": [      { \"id\": \"quizA\", \"title\": \"Number Recognition\", \"type\": \"multiple-choice\", \"concepts\": [\"number_identity\"], \"items\": [ { \"question\": \"What number comes after 4?\", \"options\": [ { \"text\": \"3\", \"correct\": false }, { \"text\": \"5\", \"correct\": true }, { \"text\": \"6\", \"correct\": false } ] } ] },      { \"id\": \"quizB\", \"title\": \"Counting Practice\", \"type\": \"list\", \"concepts\": [\"counting\"], \"items\": [] }    ],    \"nextLesson\": \"lesson2\",    \"prevLesson\": null  }}"},
    {text: "output: {\n  \"responseText\": \"Great! Let's move on to 'Basic Addition'.\",\n  \"action\": {\n    \"type\": \"showLessonOverview\",\n    \"payload\": {\n      \"lessonId\": \"lesson2\"\n    }\n  },\n  \"reasoning\": \"User requested the next lesson and the current lesson data indicates that the next lesson is lesson2.\",\n  \"contextUpdates\": null\n}"},
    {text: "input: {  \"currentUserMessage\": \"next activity\",  \"currentLlmContext\": {    \"studentProfile\": {      \"name\": \"Alex\",      \"grade\": 5,      \"age\": 10,      \"learningStyle\": \"Visual\",      \"challenges\": []    },    \"currentLesson\": {      \"id\": \"lesson1\",      \"data\": {        \"id\": \"lesson1\",        \"title\": \"Introduction to Numbers\",        \"description\": \"An introduction to basic numbers.\",        \"concepts\": [\"counting\", \"number_identity\"],        \"subject\": \"Math\",        \"progress\": \"in-progress\",        \"quizzes\": [          { \"id\": \"quizA\", \"title\": \"Number Recognition\", \"type\": \"multiple-choice\", \"concepts\": [\"number_identity\"], \"items\": [ { \"question\": \"What number comes after 4?\", \"options\": [ { \"text\": \"3\", \"correct\": false }, { \"text\": \"5\", \"correct\": true }, { \"text\": \"6\", \"correct\": false } ] } ] },          { \"id\": \"quizB\", \"title\": \"Counting Practice\", \"type\": \"list\", \"concepts\": [\"counting\"], \"items\": [] }        ],        \"nextLesson\": \"lesson2\",        \"prevLesson\": null      },      \"startTime\": \"2025-03-31T10:15:00.000Z\",      \"progressPercentage\": 90    },    \"currentQuiz\": {       \"id\": \"quizB\",       \"data\": { \"id\": \"quizB\", \"title\": \"Counting Practice\", \"type\": \"list\", \"concepts\": [\"counting\"], \"items\": [] },       \"startTime\": \"2025-03-31T10:22:00.000Z\",       \"attempts\": 1,       \"answers\": {},       \"correctCount\": 0    },    \"progressHistory\": [],    \"recentInteractions\": [      { \"user\": \"Let's begin\" },      { \"ai_response\": { \"action\": { \"type\": \"showLessonOverview\", \"payload\": { \"lessonId\": \"lesson1\" } } } },      { \"user\": \"Okay, show me the first activity\" },      { \"ai_response\": { \"action\": { \"type\": \"showQuiz\", \"payload\": { \"lessonId\": \"lesson1\", \"quizId\": \"quizA\" } } } },      { \"user\": \"I think it's 5\" },      { \"ai_response\": { \"responseText\": \"Yes, that's correct! 5 comes after 4. Great job!\", \"contextUpdates\": { \"conceptsMastered\": [\"number_identity\"] } } },      { \"user\": \"show quiz B\" },      { \"ai_response\": { \"action\": { \"type\": \"showQuiz\", \"payload\": { \"lessonId\": \"lesson1\", \"quizId\": \"quizB\" } } } }    ],    \"conceptsIntroduced\": [\"counting\", \"number_identity\"],    \"conceptsMastered\": [\"number_identity\"],    \"conceptsStruggling\": []  },  \"availableLessons\": {    \"lesson1\": \"Introduction to Numbers\",    \"lesson2\": \"Basic Addition\",    \"lesson3\": \"Counting Objects\"  },  \"currentLessonData\": {    \"id\": \"lesson1\",    \"title\": \"Introduction to Numbers\",    \"description\": \"An introduction to basic numbers.\",    \"concepts\": [\"counting\", \"number_identity\"],    \"subject\": \"Math\",    \"progress\": \"in-progress\",    \"quizzes\": [      { \"id\": \"quizA\", \"title\": \"Number Recognition\", \"type\": \"multiple-choice\", \"concepts\": [\"number_identity\"], \"items\": [ { \"question\": \"What number comes after 4?\", \"options\": [ { \"text\": \"3\", \"correct\": false }, { \"text\": \"5\", \"correct\": true }, { \"text\": \"6\", \"correct\": false } ] } ] },      { \"id\": \"quizB\", \"title\": \"Counting Practice\", \"type\": \"list\", \"concepts\": [\"counting\"], \"items\": [] }    ],    \"nextLesson\": \"lesson2\",    \"prevLesson\": null  }}"},
    {text: "output: {\n  \"responseText\": \"There are no more activities in this lesson. Would you like to finish this lesson and move on to the next one?\",\n  \"action\": null,\n  \"reasoning\": \"User asked for the next activity, but they are already on the last activity of the lesson.\",\n  \"contextUpdates\": null\n}"},
    {text: "input: {  \"currentUserMessage\": \"What's the weather like today?\",  \"currentLlmContext\": {    \"studentProfile\": {      \"name\": \"Alex\",      \"grade\": 5,      \"age\": 10,      \"learningStyle\": \"Visual\",      \"challenges\": []    },    \"currentLesson\": {      \"id\": \"lesson1\",      \"data\": {        \"id\": \"lesson1\",        \"title\": \"Introduction to Numbers\",        \"description\": \"An introduction to basic numbers.\",        \"concepts\": [\"counting\", \"number_identity\"],        \"subject\": \"Math\",        \"progress\": \"in-progress\",        \"quizzes\": [          { \"id\": \"quizA\", \"title\": \"Number Recognition\", \"type\": \"multiple-choice\", \"concepts\": [\"number_identity\"], \"items\": [ { \"question\": \"What number comes after 4?\", \"options\": [ { \"text\": \"3\", \"correct\": false }, { \"text\": \"5\", \"correct\": true }, { \"text\": \"6\", \"correct\": false } ] } ] },          { \"id\": \"quizB\", \"title\": \"Counting Practice\", \"type\": \"list\", \"concepts\": [\"counting\"], \"items\": [] }        ],        \"nextLesson\": \"lesson2\",        \"prevLesson\": null      },      \"startTime\": \"2025-03-31T10:15:00.000Z\",      \"progressPercentage\": 20    },    \"currentQuiz\": null,    \"progressHistory\": [],    \"recentInteractions\": [      { \"user\": \"Let's begin\" },      { \"ai_response\": { \"action\": { \"type\": \"showLessonOverview\", \"payload\": { \"lessonId\": \"lesson1\" } } } }    ],    \"conceptsIntroduced\": [\"counting\", \"number_identity\"],    \"conceptsMastered\": [],    \"conceptsStruggling\": []  },  \"availableLessons\": {    \"lesson1\": \"Introduction to Numbers\",    \"lesson2\": \"Basic Addition\",    \"lesson3\": \"Counting Objects\"  },  \"currentLessonData\": {    \"id\": \"lesson1\",    \"title\": \"Introduction to Numbers\",    \"description\": \"An introduction to basic numbers.\",    \"concepts\": [\"counting\", \"number_identity\"],    \"subject\": \"Math\",    \"progress\": \"in-progress\",    \"quizzes\": [      { \"id\": \"quizA\", \"title\": \"Number Recognition\", \"type\": \"multiple-choice\", \"concepts\": [\"number_identity\"], \"items\": [ { \"question\": \"What number comes after 4?\", \"options\": [ { \"text\": \"3\", \"correct\": false }, { \"text\": \"5\", \"correct\": true }, { \"text\": \"6\", \"correct\": false } ] } ] },      { \"id\": \"quizB\", \"title\": \"Counting Practice\", \"type\": \"list\", \"concepts\": [\"counting\"], \"items\": [] }    ],    \"nextLesson\": \"lesson2\",    \"prevLesson\": null  }}"},
    {text: "output: {\n  \"responseText\": \"I'm sorry, I don't have information about the weather. But I'm ready to help you with math!\",\n  \"action\": null,\n  \"reasoning\": \"The user asked a question unrelated to the current lesson or math in general.\",\n  \"contextUpdates\": null\n}"},
    {text: "input: {  \"currentUserMessage\": \"previous lesson\",  \"currentLlmContext\": {    \"studentProfile\": {      \"name\": \"Alex\",      \"grade\": 5,      \"age\": 10,      \"learningStyle\": \"Visual\",      \"challenges\": []    },    \"currentLesson\": {      \"id\": \"lesson2\",      \"data\": {        \"id\": \"lesson2\",        \"title\": \"Basic Addition\",        \"description\": \"Learning simple addition.\",        \"concepts\": [\"addition\", \"sum\"],        \"subject\": \"Math\",        \"progress\": \"in-progress\",        \"quizzes\": [           { \"id\": \"quizC\", \"title\": \"Add 1\", \"type\": \"multiple-choice\", \"concepts\": [\"addition\"], \"items\": [] }        ],        \"nextLesson\": \"lesson3\",        \"prevLesson\": \"lesson1\"      },      \"startTime\": \"2025-03-31T10:20:00.000Z\",      \"progressPercentage\": 10    },    \"currentQuiz\": null,    \"progressHistory\": [],    \"recentInteractions\": [      { \"user\": \"Let's begin\" },      { \"ai_response\": { \"action\": { \"type\": \"showLessonOverview\", \"payload\": { \"lessonId\": \"lesson1\" } } } },      { \"user\": \"Okay, show me the first activity\" },      { \"ai_response\": { \"action\": { \"type\": \"showQuiz\", \"payload\": { \"lessonId\": \"lesson1\", \"quizId\": \"quizA\" } } } },      { \"user\": \"I think it's 5\" },      { \"ai_response\": { \"responseText\": \"Yes, that's correct! 5 comes after 4. Great job!\", \"contextUpdates\": { \"conceptsMastered\": [\"number_identity\"] } } },      { \"user\": \"next lesson please\" },      { \"ai_response\": { \"action\": { \"type\": \"showLessonOverview\", \"payload\": { \"lessonId\": \"lesson2\" } } } }    ],    \"conceptsIntroduced\": [\"counting\", \"number_identity\", \"addition\", \"sum\"],    \"conceptsMastered\": [\"number_identity\"],    \"conceptsStruggling\": []  },  \"availableLessons\": {    \"lesson1\": \"Introduction to Numbers\",    \"lesson2\": \"Basic Addition\",    \"lesson3\": \"Counting Objects\"  },  \"currentLessonData\": {     \"id\": \"lesson2\",     \"title\": \"Basic Addition\",     \"description\": \"Learning simple addition.\",     \"concepts\": [\"addition\", \"sum\"],     \"subject\": \"Math\",     \"progress\": \"in-progress\",     \"quizzes\": [        { \"id\": \"quizC\", \"title\": \"Add 1\", \"type\": \"multiple-choice\", \"concepts\": [\"addition\"], \"items\": [] }     ],     \"nextLesson\": \"lesson3\",     \"prevLesson\": \"lesson1\"  }}"},
    {text: "output: {\n  \"responseText\": \"Okay! Let's go back to 'Introduction to Numbers'.\",\n  \"action\": {\n    \"type\": \"showLessonOverview\",\n    \"payload\": {\n      \"lessonId\": \"lesson1\"\n    }\n  },\n  \"reasoning\": \"User requested the previous lesson and the current lesson data indicates that the previous lesson is lesson1.\",\n  \"contextUpdates\": null\n}"},
    {text: "input: {  \"currentUserMessage\": \"previous activity\",  \"currentLlmContext\": {    \"studentProfile\": {      \"name\": \"Alex\",      \"grade\": 5,      \"age\": 10,      \"learningStyle\": \"Visual\",      \"challenges\": []    },    \"currentLesson\": {      \"id\": \"lesson1\",      \"data\": {        \"id\": \"lesson1\",        \"title\": \"Introduction to Numbers\",        \"description\": \"An introduction to basic numbers.\",        \"concepts\": [\"counting\", \"number_identity\"],        \"subject\": \"Math\",        \"progress\": \"in-progress\",        \"quizzes\": [          { \"id\": \"quizA\", \"title\": \"Number Recognition\", \"type\": \"multiple-choice\", \"concepts\": [\"number_identity\"], \"items\": [ { \"question\": \"What number comes after 4?\", \"options\": [ { \"text\": \"3\", \"correct\": false }, { \"text\": \"5\", \"correct\": true }, { \"text\": \"6\", \"correct\": false } ] } ] },          { \"id\": \"quizB\", \"title\": \"Counting Practice\", \"type\": \"list\", \"concepts\": [\"counting\"], \"items\": [] }        ],        \"nextLesson\": \"lesson2\",        \"prevLesson\": null      },      \"startTime\": \"2025-03-31T10:15:00.000Z\",      \"progressPercentage\": 10    },    \"currentQuiz\": {       \"id\": \"quizA\",       \"data\": { \"id\": \"quizA\", \"title\": \"Number Recognition\", \"type\": \"multiple-choice\", \"concepts\": [\"number_identity\"], \"items\": [ { \"question\": \"What number comes after 4?\", \"options\": [ { \"text\": \"3\", \"correct\": false }, { \"text\": \"5\", \"correct\": true }, { \"text\": \"6\", \"correct\": false } ] } ] },       \"startTime\": \"2025-03-31T10:18:00.000Z\",       \"attempts\": 0,       \"answers\": {},       \"correctCount\": 0    },    \"progressHistory\": [],    \"recentInteractions\": [      { \"user\": \"Let's begin\" },      { \"ai_response\": { \"action\": { \"type\": \"showLessonOverview\", \"payload\": { \"lessonId\": \"lesson1\" } } } },      { \"user\": \"Okay, show me the first activity\" },      { \"ai_response\": { \"action\": { \"type\": \"showQuiz\", \"payload\": { \"lessonId\": \"lesson1\", \"quizId\": \"quizA\" } } } }    ],    \"conceptsIntroduced\": [\"counting\", \"number_identity\"],    \"conceptsMastered\": [],    \"conceptsStruggling\": []  },  \"availableLessons\": {    \"lesson1\": \"Introduction to Numbers\",    \"lesson2\": \"Basic Addition\",    \"lesson3\": \"Counting Objects\"  },  \"currentLessonData\": {    \"id\": \"lesson1\",    \"title\": \"Introduction to Numbers\",    \"description\": \"An introduction to basic numbers.\",    \"concepts\": [\"counting\", \"number_identity\"],    \"subject\": \"Math\",    \"progress\": \"in-progress\",    \"quizzes\": [      { \"id\": \"quizA\", \"title\": \"Number Recognition\", \"type\": \"multiple-choice\", \"concepts\": [\"number_identity\"], \"items\": [ { \"question\": \"What number comes after 4?\", \"options\": [ { \"text\": \"3\", \"correct\": false }, { \"text\": \"5\", \"correct\": true }, { \"text\": \"6\", \"correct\": false } ] } ] },      { \"id\": \"quizB\", \"title\": \"Counting Practice\", \"type\": \"list\", \"concepts\": [\"counting\"], \"items\": [] }    ],    \"nextLesson\": \"lesson2\",    \"prevLesson\": null  }}"},
    {text: "output: {\n  \"responseText\": \"There is no previous activity in this lesson, as you're currently on the first one. Would you like to try the next activity, or perhaps review the lesson material?\",\n  \"action\": null,\n  \"reasoning\": \"The user asked for the previous activity, but they are already on the first activity of the lesson.\",\n  \"contextUpdates\": null\n}"},
    {text: "input: {  \"currentUserMessage\": \"Is it the second one?\",  \"currentLlmContext\": {    \"studentProfile\": {      \"name\": \"Alex\",      \"grade\": 5,      \"age\": 10,      \"learningStyle\": \"Visual\",      \"challenges\": []    },    \"currentLesson\": {      \"id\": \"lesson1\",      \"data\": {        \"id\": \"lesson1\",        \"title\": \"Introduction to Numbers\",        \"description\": \"An introduction to basic numbers.\",        \"concepts\": [\"counting\", \"number_identity\"],        \"subject\": \"Math\",        \"progress\": \"in-progress\",        \"quizzes\": [          { \"id\": \"quizA\", \"title\": \"Number Recognition\", \"type\": \"multiple-choice\", \"concepts\": [\"number_identity\"], \"items\": [ { \"question\": \"What number comes after 4?\", \"options\": [ { \"text\": \"3\", \"correct\": false }, { \"text\": \"5\", \"correct\": true }, { \"text\": \"6\", \"correct\": false } ] } ] },          { \"id\": \"quizB\", \"title\": \"Counting Practice\", \"type\": \"list\", \"concepts\": [\"counting\"], \"items\": [] }        ],        \"nextLesson\": \"lesson2\",        \"prevLesson\": null      },      \"startTime\": \"2025-03-31T10:15:00.000Z\",      \"progressPercentage\": 15    },    \"currentQuiz\": {       \"id\": \"quizA\",       \"data\": { \"id\": \"quizA\", \"title\": \"Number Recognition\", \"type\": \"multiple-choice\", \"concepts\": [\"number_identity\"], \"items\": [ { \"question\": \"What number comes after 4?\", \"options\": [ { \"text\": \"3\", \"correct\": false }, { \"text\": \"5\", \"correct\": true }, { \"text\": \"6\", \"correct\": false } ] } ] },       \"startTime\": \"2025-03-31T10:18:00.000Z\",       \"attempts\": 0,       \"answers\": {},       \"correctCount\": 0    },    \"progressHistory\": [],    \"recentInteractions\": [      { \"user\": \"Let's begin\" },      { \"ai_response\": { \"action\": { \"type\": \"showLessonOverview\", \"payload\": { \"lessonId\": \"lesson1\" } } } },      { \"user\": \"Okay, show me the first activity\" },      { \"ai_response\": { \"action\": { \"type\": \"showQuiz\", \"payload\": { \"lessonId\": \"lesson1\", \"quizId\": \"quizA\" } } } }    ],    \"conceptsIntroduced\": [\"counting\", \"number_identity\"],    \"conceptsMastered\": [],    \"conceptsStruggling\": []  },  \"availableLessons\": {    \"lesson1\": \"Introduction to Numbers\",    \"lesson2\": \"Basic Addition\",    \"lesson3\": \"Counting Objects\"  },  \"currentLessonData\": {    \"id\": \"lesson1\",    \"title\": \"Introduction to Numbers\",    \"description\": \"An introduction to basic numbers.\",    \"concepts\": [\"counting\", \"number_identity\"],    \"subject\": \"Math\",    \"progress\": \"in-progress\",    \"quizzes\": [      { \"id\": \"quizA\", \"title\": \"Number Recognition\", \"type\": \"multiple-choice\", \"concepts\": [\"number_identity\"], \"items\": [ { \"question\": \"What number comes after 4?\", \"options\": [ { \"text\": \"3\", \"correct\": false }, { \"text\": \"5\", \"correct\": true }, { \"text\": \"6\", \"correct\": false } ] } ] },      { \"id\": \"quizB\", \"title\": \"Counting Practice\", \"type\": \"list\", \"concepts\": [\"counting\"], \"items\": [] }    ],    \"nextLesson\": \"lesson2\",    \"prevLesson\": null  }}"},
    {text: "output: {\n  \"responseText\": \"Could you please tell me the specific number you think is the answer?\",\n  \"action\": {\n    \"type\": \"requestClarification\",\n    \"payload\": null\n  },\n  \"reasoning\": \"The user's response 'Is it the second one?' is ambiguous and requires clarification to understand the context and intent.\",\n  \"contextUpdates\": null\n}"},
    {text: "input: {  \"currentUserMessage\": \"Maybe 3?\",  \"currentLlmContext\": {    \"studentProfile\": {      \"name\": \"Alex\",      \"grade\": 5,      \"age\": 10,      \"learningStyle\": \"Visual\",      \"challenges\": []    },    \"currentLesson\": {      \"id\": \"lesson1\",      \"data\": {        \"id\": \"lesson1\",        \"title\": \"Introduction to Numbers\",        \"description\": \"An introduction to basic numbers.\",        \"concepts\": [\"counting\", \"number_identity\"],        \"subject\": \"Math\",        \"progress\": \"in-progress\",        \"quizzes\": [          { \"id\": \"quizA\", \"title\": \"Number Recognition\", \"type\": \"multiple-choice\", \"concepts\": [\"number_identity\"], \"items\": [ { \"question\": \"What number comes after 4?\", \"options\": [ { \"text\": \"3\", \"correct\": false }, { \"text\": \"5\", \"correct\": true }, { \"text\": \"6\", \"correct\": false } ] } ] },          { \"id\": \"quizB\", \"title\": \"Counting Practice\", \"type\": \"list\", \"concepts\": [\"counting\"], \"items\": [] }        ],        \"nextLesson\": \"lesson2\",        \"prevLesson\": null      },      \"startTime\": \"2025-03-31T10:15:00.000Z\",      \"progressPercentage\": 15    },    \"currentQuiz\": {       \"id\": \"quizA\",       \"data\": { \"id\": \"quizA\", \"title\": \"Number Recognition\", \"type\": \"multiple-choice\", \"concepts\": [\"number_identity\"], \"items\": [ { \"question\": \"What number comes after 4?\", \"options\": [ { \"text\": \"3\", \"correct\": false }, { \"text\": \"5\", \"correct\": true }, { \"text\": \"6\", \"correct\": false } ] } ] },       \"startTime\": \"2025-03-31T10:18:00.000Z\",       \"attempts\": 0,       \"answers\": {},       \"correctCount\": 0    },    \"progressHistory\": [],    \"recentInteractions\": [      { \"user\": \"Let's begin\" },      { \"ai_response\": { \"action\": { \"type\": \"showLessonOverview\", \"payload\": { \"lessonId\": \"lesson1\" } } } },      { \"user\": \"Okay, show me the first activity\" },      { \"ai_response\": { \"action\": { \"type\": \"showQuiz\", \"payload\": { \"lessonId\": \"lesson1\", \"quizId\": \"quizA\" } } } }    ],    \"conceptsIntroduced\": [\"counting\", \"number_identity\"],    \"conceptsMastered\": [],    \"conceptsStruggling\": []  },  \"availableLessons\": {    \"lesson1\": \"Introduction to Numbers\",    \"lesson2\": \"Basic Addition\",    \"lesson3\": \"Counting Objects\"  },  \"currentLessonData\": {    \"id\": \"lesson1\",    \"title\": \"Introduction to Numbers\",    \"description\": \"An introduction to basic numbers.\",    \"concepts\": [\"counting\", \"number_identity\"],    \"subject\": \"Math\",    \"progress\": \"in-progress\",    \"quizzes\": [      { \"id\": \"quizA\", \"title\": \"Number Recognition\", \"type\": \"multiple-choice\", \"concepts\": [\"number_identity\"], \"items\": [ { \"question\": \"What number comes after 4?\", \"options\": [ { \"text\": \"3\", \"correct\": false }, { \"text\": \"5\", \"correct\": true }, { \"text\": \"6\", \"correct\": false } ] } ] },      { \"id\": \"quizB\", \"title\": \"Counting Practice\", \"type\": \"list\", \"concepts\": [\"counting\"], \"items\": [] }    ],    \"nextLesson\": \"lesson2\",    \"prevLesson\": null  }}"},
    {text: "output: {\n  \"responseText\": \"Not quite. Remember, we're looking for the number that comes right after 4 when counting. Think about counting: 1, 2, 3, 4, ... What's next?\",\n  \"action\": null,\n  \"reasoning\": \"The user answered the question incorrectly and needs to try again.\",\n  \"contextUpdates\": null\n}"},
    {text: "input: {  \"currentUserMessage\": \"Start lesson2\",  \"currentLlmContext\": {    \"studentProfile\": {      \"name\": \"Alex\",      \"grade\": 5,      \"age\": 10,      \"learningStyle\": \"Visual\",      \"challenges\": []    },    \"currentLesson\": null,    \"currentQuiz\": null,    \"progressHistory\": [],    \"recentInteractions\": [],    \"conceptsIntroduced\": [],    \"conceptsMastered\": [],    \"conceptsStruggling\": []  },  \"availableLessons\": {    \"lesson1\": \"Introduction to Numbers\",    \"lesson2\": \"Basic Addition\",    \"lesson3\": \"Counting Objects\"  },  \"currentLessonData\": null}"},
    {text: "output: {\n  \"responseText\": \"Great! Let's begin with lesson 'Basic Addition'. I'll bring up the overview.\",\n  \"action\": {\n    \"type\": \"showLessonOverview\",\n    \"payload\": {\n      \"lessonId\": \"lesson2\"\n    }\n  },\n  \"reasoning\": \"User wants to start lesson2, no active lesson. Initiating lesson2 overview.\",\n  \"contextUpdates\": null\n}"},
    {text: "input: {  \"currentUserMessage\": \"show quiz 1\",  \"currentLlmContext\": {    \"studentProfile\": {      \"name\": \"Alex\",      \"grade\": 5,      \"age\": 10,      \"learningStyle\": \"Visual\",      \"challenges\": []    },    \"currentLesson\": {      \"id\": \"lesson1\",      \"data\": {        \"id\": \"lesson1\",        \"title\": \"Introduction to Numbers\",        \"description\": \"An introduction to basic numbers.\",        \"concepts\": [\"counting\", \"number_identity\"],        \"subject\": \"Math\",        \"progress\": \"in-progress\",        \"quizzes\": [          { \"id\": \"quiz1\", \"title\": \"Number Recognition\", \"type\": \"multiple-choice\", \"concepts\": [\"number_identity\"], \"items\": [ { \"question\": \"What number comes after 4?\", \"options\": [ { \"text\": \"3\", \"correct\": false }, { \"text\": \"5\", \"correct\": true }, { \"text\": \"6\", \"correct\": false } ] } ] },          { \"id\": \"quizB\", \"title\": \"Counting Practice\", \"type\": \"list\", \"concepts\": [\"counting\"], \"items\": [] }        ],        \"nextLesson\": \"lesson2\",        \"prevLesson\": null      },      \"startTime\": \"2025-03-31T10:15:00.000Z\",      \"progressPercentage\": 50    },    \"currentQuiz\": null,    \"progressHistory\": [],    \"recentInteractions\": [      { \"user\": \"Let's begin\" },      { \"ai_response\": { \"action\": { \"type\": \"showLessonOverview\", \"payload\": { \"lessonId\": \"lesson1\" } } } },      { \"user\": \"Okay, show me the first activity\" },      { \"ai_response\": { \"action\": { \"type\": \"showQuiz\", \"payload\": { \"lessonId\": \"lesson1\", \"quizId\": \"quizA\" } } } },      { \"user\": \"I think it's 5\" },      { \"ai_response\": { \"responseText\": \"Yes, that's correct! 5 comes after 4. Great job!\", \"contextUpdates\": { \"conceptsMastered\": [\"number_identity\"] } } }    ],    \"conceptsIntroduced\": [\"counting\", \"number_identity\"],    \"conceptsMastered\": [\"number_identity\"],    \"conceptsStruggling\": []  },  \"availableLessons\": {    \"lesson1\": \"Introduction to Numbers\",    \"lesson2\": \"Basic Addition\",    \"lesson3\": \"Counting Objects\"  },  \"currentLessonData\": {    \"id\": \"lesson1\",    \"title\": \"Introduction to Numbers\",    \"description\": \"An introduction to basic numbers.\",    \"concepts\": [\"counting\", \"number_identity\"],    \"subject\": \"Math\",    \"progress\": \"in-progress\",    \"quizzes\": [      { \"id\": \"quizA\", \"title\": \"Number Recognition\", \"type\": \"multiple-choice\", \"concepts\": [\"number_identity\"], \"items\": [ { \"question\": \"What number comes after 4?\", \"options\": [ { \"text\": \"3\", \"correct\": false }, { \"text\": \"5\", \"correct\": true }, { \"text\": \"6\", \"correct\": false } ] } ] },      { \"id\": \"quizB\", \"title\": \"Counting Practice\", \"type\": \"list\", \"concepts\": [\"counting\"], \"items\": [] }    ],    \"nextLesson\": \"lesson2\",    \"prevLesson\": null  }}"},
    {text: "output: {\n  \"responseText\": \"Okay, here is the 'Counting Practice' activity.\",\n  \"action\": {\n    \"type\": \"showQuiz\",\n    \"payload\": {\n      \"lessonId\": \"lesson1\",\n      \"quizId\": \"quiz1\"\n    }\n  },\n  \"reasoning\": \"The user specifically requested quiz 1.\",\n  \"contextUpdates\": null\n}"},
    {
      text: `input: ${JSON.stringify({
        currentUserMessage,
        currentLlmContext,
        availableLessons,
        currentLessonData // Include if available
      })}`
    },
    { text: "output: " } // Instruct the model to start the output
  ];

  try {
    const llmPayload = {
        contents: [{ role: "user", parts }],
        generationConfig,
        safetySettings,
    };
    reqLogger.logPayload('llm_request', llmPayload); // Log LLM request payload

    const result = await model.generateContent(llmPayload);

    reqLogger.info("Received raw response from Gemini."); // Log confirmation

    // --- Response Handling ---
    if (!result.response) {
        reqLogger.error("Gemini response object was undefined.");
        throw new Error("No response object received from LLM.");
    }

    const candidates = result.response.candidates;
    if (!candidates || candidates.length === 0 || !candidates[0].content || !candidates[0].content.parts || candidates[0].content.parts.length === 0) {
        reqLogger.error("Invalid response structure from Gemini: Missing candidates or content parts.", { response: result.response });
        // Check for safety feedback
        const blockReason = result.response.promptFeedback?.blockReason;
        if (blockReason) {
             reqLogger.warn(`LLM request blocked by safety filter`, { blockReason, safetyRatings: result.response.promptFeedback?.safetyRatings });
             reqLogger.endRequest(400, { error: "Content blocked by safety filters", blockReason });
             return NextResponse.json({ error: `Content blocked by safety filters: ${blockReason}` }, { status: 400 });
        }
        throw new Error("Invalid or empty response content from LLM.");
    }

    const responseText = candidates[0].content.parts[0].text;
    reqLogger.logPayload('llm_response', responseText); // Log raw response text (or size in prod)
    if (!responseText) {
        reqLogger.error("Empty text part in Gemini response.", { parts: candidates[0].content.parts });
        throw new Error("Empty response text from LLM.");
    }

    // Attempt to parse the JSON response text
    let parsedResponse;
    try {
        // Attempt to extract JSON block if wrapped in markdown
        const jsonRegex = /```json\s*([\s\S]*?)\s*```/;
        const match = responseText.match(jsonRegex);
        const jsonToParse = match ? match[1].trim() : responseText.trim(); // Use extracted or trimmed raw text

        if (!jsonToParse) {
             reqLogger.error("Extracted JSON string is empty after regex/trim.", { rawResponse: responseText });
             throw new Error("Empty JSON content from LLM response.");
        }

        parsedResponse = JSON.parse(jsonToParse);
        reqLogger.info("Successfully parsed Gemini JSON response.");
        // Extract token usage if available
        const tokenUsage = result.response?.usageMetadata?.totalTokenCount;
        reqLogger.logLlmResult(parsedResponse, tokenUsage); // Log parsed result, timing, and token usage
        // --- Start Payload Validation Logic ---
        const requiredPayloadActions = ['showLessonOverview', 'showQuiz', 'completeLesson'];
        const action = parsedResponse.action; // Assuming parsedResponse holds the parsed JSON

        if (action && requiredPayloadActions.includes(action.type)) {
          if (!action.payload) {
            reqLogger.error(`Validation Error: Action '${action.type}' requires a payload, but it was missing.`, { action });
            throw new Error(`LLM response action '${action.type}' missing required payload.`);
          }

          if ((action.type === 'showLessonOverview' || action.type === 'completeLesson') && (!action.payload.lessonId || typeof action.payload.lessonId !== 'string')) {
             reqLogger.error(`Validation Error: Action '${action.type}' payload missing or invalid 'lessonId'.`, { payload: action.payload });
             throw new Error(`LLM response payload for '${action.type}' missing required 'lessonId'.`);
          }

          if (action.type === 'showQuiz' && (!action.payload.lessonId || typeof action.payload.lessonId !== 'string' || !action.payload.quizId || typeof action.payload.quizId !== 'string')) {
             reqLogger.error(`Validation Error: Action '${action.type}' payload missing or invalid 'lessonId' or 'quizId'.`, { payload: action.payload });
             throw new Error(`LLM response payload for '${action.type}' missing required 'lessonId' or 'quizId'.`);
          }
          reqLogger.debug(`Payload validation passed for action type: ${action.type}`);
        }
        // --- End Payload Validation Logic ---

    } catch (parseError) {
        reqLogger.error("Error parsing Gemini JSON response", parseError instanceof Error ? parseError : { error: parseError });
        reqLogger.error("Raw response text that failed parsing:", { rawResponse: responseText }); // Log raw text for debugging
        // Return a specific error response to the client
        reqLogger.endRequest(500, { error: "Failed to parse LLM response" });
        return NextResponse.json({ error: "Failed to parse LLM response as JSON." }, { status: 500 });
    }

    // Return the parsed JSON object
    reqLogger.endRequest(200, { actionType: parsedResponse.action?.type });
    return NextResponse.json(parsedResponse);

  } catch (error) {
    reqLogger.error("Unhandled error in chat API handler", error instanceof Error ? error : { error: error });
    const errorMessage = error instanceof Error ? error.message : "An unknown error occurred";
    // Ensure request ends even on unhandled errors
    if (!reqLogger.hasEnded()) { // Use the getter method
        reqLogger.endRequest(500, { error: errorMessage });
    }
    return NextResponse.json({ error: `LLM API call failed: ${errorMessage}` }, { status: 500 });
  }
}